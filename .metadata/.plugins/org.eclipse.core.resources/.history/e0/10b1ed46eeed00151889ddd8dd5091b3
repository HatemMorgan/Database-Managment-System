package Database2Project;

import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.ObjectInputStream;
import java.io.ObjectOutputStream;
import java.util.Hashtable;
import java.util.Iterator;

import Database2Project.Table;
import Exceptions.DBAppException;
import Exceptions.DBEngineException;



public class DBApp {
Database myDataBase;
String WorkSpacePath = System.getProperty("user.dir") ;
	
	public void init( ) throws ClassNotFoundException, IOException{
	   myDataBase=deserializeDatabase();
    }
	
	public Database CreateDatabase () throws IOException{
		Database newDatabase = new Database();
		SerializeDatabase( newDatabase);
		System.out.println(" Database created successfully");
		return newDatabase;
	}

	public void SerializeDatabase (Database newDatabase) throws IOException{
		ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(new File("MyDataBase.class")));
			oos.writeObject(newDatabase);
			oos.flush();
		oos.close();
	}

	public Database deserializeDatabase () throws ClassNotFoundException, IOException{
		Database targetDatabase = null;
		
		File file = new File(WorkSpacePath+"/MyDataBase.class");
		if(file.exists()){
		ObjectInputStream ois = new ObjectInputStream(new FileInputStream(new File("MyDataBase.class")));
	     targetDatabase = (Database)ois.readObject();
	    ois.close();

	    
		}else{
			targetDatabase = CreateDatabase();
		}
	    return targetDatabase;
	}


	
    public void createTable(String strTableName,    Hashtable<String,String> htblColNameType, 
                            Hashtable<String,String> htblColNameRefs, String strKeyColName)  throws DBAppException, IOException{
    
    	myDataBase.createTable(strTableName, htblColNameType, htblColNameRefs, strKeyColName);
    	createIndex(strTableName, strKeyColName);
    	SerializeDatabase(myDataBase);
    	
    	
    }

    public void createIndex(String strTableName, String strColName)  throws DBAppException, IOException{
        myDataBase.createIndex(strTableName, strColName);
        SerializeDatabase(myDataBase);
    }

    public void insertIntoTable(String strTableName, Hashtable<String,Object> htblColNameValue)  throws DBAppException, FileNotFoundException, ClassNotFoundException, IOException{
    myDataBase.insertIntoTable(strTableName, htblColNameValue);
    SerializeDatabase(myDataBase);
    }

    public void updateTable(String strTableName, Object strKey,
                            Hashtable<String,Object> htblColNameValue)  throws DBAppException, FileNotFoundException, ClassNotFoundException, IOException{
    myDataBase.UpdateTable(strTableName, strKey, htblColNameValue);
    SerializeDatabase(myDataBase);
    }


    public void deleteFromTable(String strTableName, Hashtable<String,Object> htblColNameValue, 
                                String strOperator) throws DBEngineException, FileNotFoundException, ClassNotFoundException, IOException{
                  myDataBase.DeleteFromTable(strTableName, htblColNameValue, strOperator);
                  SerializeDatabase(myDataBase);
    }
		
    public Iterator selectFromTable(String strTable,  Hashtable<String,Object> htblColNameValue, 
                                    String strOperator) throws DBEngineException, FileNotFoundException, ClassNotFoundException, IOException{
      
    	return myDataBase.SelectFromTable(strTable, htblColNameValue, strOperator);
    }

    public static void main(String [] args) throws DBAppException, DBEngineException, FileNotFoundException, ClassNotFoundException, IOException {
		// creat a new DBApp
		DBApp myDB = new DBApp();

		// initialize it
		myDB.init();

	
		// creating table "Faculty"
     
				Hashtable<String, String> fTblColNameType = new Hashtable<String, String>();
				fTblColNameType.put("ID", "Integer");
				fTblColNameType.put("Name", "String");

				Hashtable<String, String> fTblColNameRefs = new Hashtable<String, String>();

				myDB.createTable("Faculty", fTblColNameType, fTblColNameRefs, "ID");

				// creating table "Major"

				Hashtable<String, String> mTblColNameType = new Hashtable<String, String>();
				mTblColNameType.put("ID", "Integer");
				mTblColNameType.put("Name", "String");
				mTblColNameType.put("Faculty_ID", "Integer");

				Hashtable<String, String> mTblColNameRefs = new Hashtable<String, String>();
				mTblColNameRefs.put("Faculty_ID", "Faculty.ID");

				myDB.createTable("Major", mTblColNameType, mTblColNameRefs, "ID");

				// creating table "Course"

				Hashtable<String, String> coTblColNameType = new Hashtable<String, String>();
				coTblColNameType.put("ID", "Integer");
				coTblColNameType.put("Name", "String");
				coTblColNameType.put("Code", "String");
				coTblColNameType.put("Hours", "Integer");
				coTblColNameType.put("Semester", "Integer");
				coTblColNameType.put("Major_ID", "Integer");

				Hashtable<String, String> coTblColNameRefs = new Hashtable<String, String>();
				coTblColNameRefs.put("Major_ID", "Major.ID");

				myDB.createTable("Course", coTblColNameType, coTblColNameRefs, "ID");

				// creating table "Student"

				Hashtable<String, String> stTblColNameType = new Hashtable<String, String>();
				stTblColNameType.put("ID", "Integer");
				stTblColNameType.put("First_Name", "String");
				stTblColNameType.put("Last_Name", "String");
				stTblColNameType.put("GPA", "Double");
				stTblColNameType.put("Age", "Integer");

				Hashtable<String, String> stTblColNameRefs = new Hashtable<String, String>();

				myDB.createTable("Student", stTblColNameType, stTblColNameRefs, "ID");

				// creating table "Student in Course"

				Hashtable<String, String> scTblColNameType = new Hashtable<String, String>();
				scTblColNameType.put("ID", "Integer");
				scTblColNameType.put("Student_ID", "Integer");
				scTblColNameType.put("Course_ID", "Integer");

				Hashtable<String, String> scTblColNameRefs = new Hashtable<String, String>();
				scTblColNameRefs.put("Student_ID", "Student.ID");
				scTblColNameRefs.put("Course_ID", "Course.ID");

				myDB.createTable("Student_in_Course", scTblColNameType, scTblColNameRefs, "ID");

				// insert in table "Faculty"

				Hashtable<String,Object> ftblColNameValue1 = new Hashtable<String,Object>();
				ftblColNameValue1.put("ID", Integer.valueOf( "0" ) );
				ftblColNameValue1.put("Name", "Media Engineering and Technology");
				myDB.insertIntoTable("Faculty", ftblColNameValue1);

				Hashtable<String,Object> ftblColNameValue2 = new Hashtable<String,Object>();
				ftblColNameValue2.put("ID", Integer.valueOf( "1" ) );
				ftblColNameValue2.put("Name", "Management Technology");
				myDB.insertIntoTable("Faculty", ftblColNameValue2);

				for(int i=0;i<1000;i++)
				{
					Hashtable<String,Object> ftblColNameValueI = new Hashtable<String,Object>();
					ftblColNameValueI.put("ID", Integer.valueOf( (""+(i+2)) ) );
					ftblColNameValueI.put("Name", "f"+(i+2));
					myDB.insertIntoTable("Faculty", ftblColNameValueI);
				}

				// insert in table "Major"

				Hashtable<String,Object> mtblColNameValue1 = new Hashtable<String,Object>();
				mtblColNameValue1.put("ID", Integer.valueOf( "0" ) );
				mtblColNameValue1.put("Name", "Computer Science & Engineering");
				mtblColNameValue1.put("Faculty_ID", Integer.valueOf( "1" ) );
				myDB.insertIntoTable("Major", mtblColNameValue1);

				Hashtable<String,Object> mtblColNameValue2 = new Hashtable<String,Object>();
				mtblColNameValue2.put("ID", Integer.valueOf( "1" ));
				mtblColNameValue2.put("Name", "Business Informatics");
				mtblColNameValue2.put("Faculty_ID", Integer.valueOf( "2" ));
				myDB.insertIntoTable("Major", mtblColNameValue2);

				for(int i=0;i<1000;i++)
				{
					Hashtable<String,Object> mtblColNameValueI = new Hashtable<String,Object>();
					mtblColNameValueI.put("ID", Integer.valueOf( (""+(i+2) ) ));
					mtblColNameValueI.put("Name", "m"+(i+2));
					mtblColNameValueI.put("Faculty_ID", Integer.valueOf( (""+(i+2) ) ));
					myDB.insertIntoTable("Major", mtblColNameValueI);
				}


				// insert in table "Course"

				Hashtable<String,Object> ctblColNameValue1 = new Hashtable<String,Object>();
				ctblColNameValue1.put("ID", Integer.valueOf( "0" ) );
				ctblColNameValue1.put("Name", "Data Bases II");
				ctblColNameValue1.put("Code", "CSEN 604");
				ctblColNameValue1.put("Hours", Integer.valueOf( "4" ));
				ctblColNameValue1.put("Semester", Integer.valueOf( "6" ));
				ctblColNameValue1.put("Major_ID", Integer.valueOf( "1" ));
				myDB.insertIntoTable("Course", mtblColNameValue1);

				Hashtable<String,Object> ctblColNameValue2 = new Hashtable<String,Object>();
				ctblColNameValue2.put("ID", Integer.valueOf( "1" ) );
				ctblColNameValue2.put("Name", "Data Bases II");
				ctblColNameValue2.put("Code", "CSEN 604");
				ctblColNameValue2.put("Hours", Integer.valueOf( "4" ) );
				ctblColNameValue2.put("Semester", Integer.valueOf( "6" ) );
				ctblColNameValue2.put("Major_ID", Integer.valueOf( "2" ) );
				myDB.insertIntoTable("Course", mtblColNameValue2);

				for(int i=0;i<1000;i++)
				{
					Hashtable<String,Object> ctblColNameValueI = new Hashtable<String,Object>();
					ctblColNameValueI.put("ID", Integer.valueOf( ( ""+(i+2) )));
					ctblColNameValueI.put("Name", "c"+(i+2));
					ctblColNameValueI.put("Code", "co "+(i+2));
					ctblColNameValueI.put("Hours", Integer.valueOf( "4" ) );
					ctblColNameValueI.put("Semester", Integer.valueOf( "6" ) );
					ctblColNameValueI.put("Major_ID", Integer.valueOf( ( ""+(i+2) )));
					myDB.insertIntoTable("Course", ctblColNameValueI);
				}

				// insert in table "Student"

				for(int i=0;i<1000;i++)
				{
					Hashtable<String,Object> sttblColNameValueI = new Hashtable<String,Object>();
					sttblColNameValueI.put("ID", Integer.valueOf( ( ""+i ) ) );
					sttblColNameValueI.put("First_Name", "FN"+i);
					sttblColNameValueI.put("Last_Name", "LN"+i);
					sttblColNameValueI.put("GPA", Double.valueOf( "0.7" ) ) ;
					sttblColNameValueI.put("Age", Integer.valueOf( "20" ) );
					myDB.insertIntoTable("Student", sttblColNameValueI);
				//changed it to student instead of course
				}


		// selecting


		  Hashtable<String,Object> stblColNameValue = new Hashtable<String,Object>();
		stblColNameValue.put("ID", Integer.valueOf( "400" ) );
		//stblColNameValue.put("Age", Integer.valueOf( "20" ) );

		long startTime = System.currentTimeMillis();
		Iterator myIt = myDB.selectFromTable("Student", stblColNameValue,"");
		long endTime   = System.currentTimeMillis();
		long totalTime = endTime - startTime;
		System.out.println(totalTime);
		while(myIt.hasNext()) {
			System.out.println(myIt.next());
		}

		// feel free to add more tests
		/*
        Hashtable<String,Object> stblColNameValue3 = new Hashtable<String,Object>();
		stblColNameValue3.put("Name", "m7");
		stblColNameValue3.put("Faculty_ID", Integer.valueOf( "7" ) );

      long startTime2 = System.currentTimeMillis();
		Iterator myIt2 = myDB.selectFromTable("Major", stblColNameValue3,"AND");
		long endTime2   = System.currentTimeMillis();
		long totalTime2 = endTime2 - startTime2;
		System.out.println(totalTime2);
		while(myIt2.hasNext()) {
			System.out.println(myIt2.next());
		}
		
*/
		Hashtable<String,Object> stblColNameValue1 = new Hashtable<String,Object>();
		stblColNameValue1.put("GPA", Double.valueOf( "2.9" ) );
		stblColNameValue1.put("Age", Integer.valueOf( "21" ));
		myDB.updateTable("Student",Integer.valueOf("994"),stblColNameValue1);
		
	
		Hashtable<String,Object> stblColNameValueTag = new Hashtable<String,Object>();
		//stblColNameValueTag.put("ID", Integer.valueOf( "502" ) );
		stblColNameValueTag.put("Age", Integer.valueOf( "21" ) );
		
		long startTime3 = System.currentTimeMillis();
		Iterator myIt3 = myDB.selectFromTable("Student", stblColNameValueTag,"");
		long endTime3   = System.currentTimeMillis();
		long totalTime3 = endTime3 - startTime3;
		System.out.println(totalTime3);
		while(myIt3.hasNext()) {
			System.out.println(myIt3.next());
		}

		Hashtable<String,Object> stblColNameValueTag1 = new Hashtable<String,Object>();
		stblColNameValueTag1.put("ID", Integer.valueOf( "994" ) );
		//stblColNameValueTag1.put("Age", Integer.valueOf( "20" ) );
		
		long startTime6 = System.currentTimeMillis();
		Iterator myIt6= myDB.selectFromTable("Student", stblColNameValueTag1,"");
		long endTime6  = System.currentTimeMillis();
		long totalTime6 = endTime6 - startTime6;
		System.out.println(totalTime6);
		while(myIt6.hasNext()) {
			System.out.println(myIt6.next());
		}
		/*

        long startTime4 = System.currentTimeMillis();
        myDB.deleteFromTable("Student", stblColNameValueTag1,"");
		long endTime4  = System.currentTimeMillis();
		long totalTime4 = endTime4 - startTime4;
		System.out.println(totalTime4);
		
		long startTime5 = System.currentTimeMillis();
		Iterator myIt5 = myDB.selectFromTable("Student", stblColNameValueTag1,"");
		long endTime5   = System.currentTimeMillis();
		long totalTime5 = endTime5 - startTime5;
		System.out.println(totalTime5);
		while(myIt5.hasNext()) {
			System.out.println(myIt5.next());
		}
		*/
	}



}